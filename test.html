<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Google Sheets Dropdown</title>
</head>

<body>
	<h2>Select a Value</h2>
	<form id="theform">
		<select id="dropdown">
			<option value="default">Let the donor pick the organization</option>
		</select>
		<input type="text" id="givingID" />
		<input type="submit" value="Generate">
	</form>

	<p id="url"></p>

	<script type="module">
		import { fetchData, buildURL, extractGivingID } from './main.mjs';
		const givingid = document.getElementById("givingID")
		const dropdown = document.getElementById("dropdown")
		const theform = document.getElementById("theform")


		function validateForm(e) {
			const valid = theform.reportValidity()
			givingid.setCustomValidity("")
			
		    if (!extractGivingID(givingid.value))
				givingid.setCustomValidity("Invalid value. Either leave this blank, enter your attribution number, or enter a url attributed to you")
			    return false


			if (!valid)
				e.preventDefault()
			return true

		}
		theform.onsubmit = validateForm

		
		function updateURL() {
			let ddvalue = dropdown.value
			if (ddvalue == "default"){
				ddvalue == ""
			}
			const url = buildURL(ddvalue, givingid.value);
			document.getElementById("url").textContent = `Generated URL: ${url}`;
		}
		dropdown.onchange = updateURL
		givingid.onchange = updateURL


		// Load data on page load
		window.onload = fetchData().then((result) => {
			// console.log(data);
			// Populate the dropdown
			const dropdown = document.getElementById("dropdown");
			result.forEach(row => {
				const option = document.createElement("option");
				option.value = row[0];  // Assume the value you want is in the first column
				option.textContent = row[0];
				dropdown.appendChild(option);
			});
		});
	</script>
</body>

</html>